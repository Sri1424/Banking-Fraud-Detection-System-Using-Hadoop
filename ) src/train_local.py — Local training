import argparse
import os
import pandas as pd 
import numpy as np
import joblib
from sklearn.preprocessing import
OrdinalEncoder, StandardScaler
from sklearn.ensemble import
RandomForestClassifier
from sklearn.model_selection import
GridSearchCV
from sklearn.metrics import
average_precision_score,
roc_auc_score, classification_report
def main(args):
df = pd.read_csv(args.data,
parse_dates=["timestamp"])
df =
df.sort_values("timestamp").reset_index
(drop=True)
df["amount_log"] =
np.log1p(df["amount"].astype(float)) 
df["txn_hour"] =
df["timestamp"].dt.hour +
df["timestamp"].dt.minute/60.0
df["avg_amount_acc"] =
df.groupby("account_id")["amount"].tra
nsform("mean").fillna(0.0)
enc =
OrdinalEncoder(handle_unknown='use_
encoded_value', unknown_value=-1)
df["merchant_cat_idx"] =
enc.fit_transform(df[["merchant_catego
ry"]]).astype(int)
feature_cols =
["amount_log",_acc","merchant_cat_idx"] 
split_idx = int(0.8 * len(df))
train = df.iloc[:split_idx]
test = df.iloc[split_idx:]
X_train = train[feature_cols].values
y_train =
train["is_fraud"].astype(int).values
X_test = test[feature_cols].values
y_test =
test["is_fraud"].astype(int).values
scaler = StandardScaler()
X_train_s =
scaler.fit_transform(X_train)
X_test_s = scaler.transform(X_test) 
clf =
RandomForestClassifier(class_weight='
balanced', random_state=42, n_jobs=-1)
param_grid = {"n_estimators":[100],
"max_depth":[8]}
grid = GridSearchCV(clf,
param_grid,
scoring='average_precision', cv=2,
n_jobs=2, verbose=1)
grid.fit(X_train_s, y_train)
best = grid.best_estimator_
y_scores =
best.predict_proba(X_test_s)[:,1]
print("AUC-PR:",
average_precision_score(y_test,
y_scores))
print(classification_report(y_test,
best.predict(X_test_s), digits=4)) 
os.makedirs(os.path.dirname(args.out),
exist_ok=True)
joblib.dump({"scaler":scaler,
"model":best, "features":feature_cols},
args.out)
print("Saved model to", args.out)
if name == " main ":
parser = argparse.ArgumentParser()
parser.add_argument("--data",
required=True)
parser.add_argument("--out",
required=True)
main(parser.parse_args()) 

















































"txn_hour","avg_amount 
